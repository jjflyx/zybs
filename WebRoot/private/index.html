<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>$!app_name</title>
		<script type='text/javascript'>
			var CONTEXTPATH = '${base}';
			var stylePath = '$!stylename';
		</script>
		<link rel="stylesheet" type="text/css"  href="${base}/include/css/blue/style.css" />
		<link href="${base}/include/css/msg.css" rel="stylesheet" type="text/css" />
		<link href="${base}/include/css/easyui.css" rel="stylesheet" type="text/css" />
		<script type="text/javascript" src="${base}/include/js/main.js"></script>
		<script type="text/javascript" src="${base}/include/js/string.js"></script>
		<script type="text/javascript" src="${base}/include/js/jquery.easyui.pack.js"></script>
		<script type="text/javascript" src='${base}/include/js/tabpage.js'></script>
		<script type="text/javascript" src='${base}/include/js/mainfrm.js'></script>
		<!--[if IE 6]>
			<script language="javascript" type="text/javascript" src="${base}/include/js/DD_belatedPNG.min.js"></script>
		<![endif]-->
	</head>
	<body class="mainbg">
		<input type="hidden" id="shift" value="" />
		<input type="hidden" id="three" value="" />
		<input type="hidden" id="appid" value="" />
		<div id="mainFrame" class="mainwidth">
			<div  id="headbox">
				<div class="top">
					<!--右顶侧菜单-->
					<div class="top_right" >
								
						<ul>
						 	<li>
						 	<a href="javascript:changePassword();" title="个人信息" class="png"><img
										src="${base}/include/img/r_icon5.png" width="34" height="30"
										border="0" class="png" />
								</a>
						 	</li>
							<li>
								<a href="javascript:openSystemHelp()" title="帮助" class="png"><img
										src="${base}/include/img/r_icon2.png" width="34" height="30"
										border="0" class="png" />
								</a>
							</li>
							<li>
								<a href="javascript:lock()" title="锁屏" class="png"><img
										src="${base}/include/img/r_icon3.png" width="34" height="30"
										border="0" class="png" />
								</a>
							</li>

						</ul>
						 <div class="clear"></div>
                        <div class="exit_btn"><a href="javascript:logout()" class="png" title="退出"><img src="${base}/include/img/icon_close_tbtn.png" border="0" class="png" />退出</a></div>
					</div>
					<div class="top_left">
						<div class="top_logo png"><h1 class="png">$!app_name</h1></div>
					</div>
					<!--系统菜单切换-->
					<div class="topmain_right">
						#if("$!user.unitid"=="0001")
						<div style="padding-top: 8px; text-align: center;">
							<select name="appname" id="appname"></select>
						</div>
						#end
					</div>
					<div class="clear"></div>
				</div>
				<!--上部系统菜单-->
				<div class="Nmenu">
					<div class="Nmenu_menu">
						<ul>
							#foreach($modules in $modulessublist)
							<li>
								<a
									href="javascript:dochange('$!modules.id','$!modules.url','$!modules.name');dochangeimg($!velocityCount)"
									class="Mmenu png" id=menuid$!velocityCount
									title="$!modules.name"><strong class="png"><span
										class="png"> #if($!{modules.name.toString().length()} >
											10) $!{modules.name.toString().substring(0,10)} #else
											$!modules.name #end </span>
								</strong>
								</a>
							</li>
							#if($!velocityCount==1)
							<script type="text/javascript">
                                $(document).ready(function(){
                                    dochange('$!modules.id', '$!modules.url', '$!modules.name');
                                    dochangeimg('$!velocityCount');
                                });
                            </script>
							#end #end
							<!--Class Mmenu and Mmenu_this-->
						</ul>
					</div>
					<div class="clear"></div>
				</div>
			</div>
			<!--中间区域-->
			<table width="100%" border="0" cellspacing="0" cellpadding="0"
				style="position: relative;" class="mainCon">
				<tr>
					<td width="160" valign="top" class="content_l" id="leftArea">
						<div class="content_l_gnmenu" id="leftTop">
							<!--个人信息及通知-->
							<div class="Nmenu_user">
								<div class="Nmenu_user_left ">
									<a href="javascript:changePassword();">
										<img src="${base}/include/img/user.png" border="0" class="png" />
									</a>
								</div>
								<div class="Nmenu_user_right">
								<div class="Nmenu_user_right" id="dvonline"></div>
									<div id="notic_div" class="Nmenu_user_notic png"
										#if($notices_num && $!notices_num!=0)style= "display:
										block;"#else style="display: none;" #end>
										<a id="notic_a" href="javascript:void(0);"
											onclick="toNoticesPage();"
											style="color: white; text-decoration: none">$!notices_num</a>
									</div>
								</div>
								<div class="clear"></div>
							</div>
						</div>
						<div class="clear"></div>
						<div id="leftdiv">
							<iframe name="leftFrame" allowtransparency="true" id="leftFrame"
								width="100%" height="100%" frameborder="NO" scrolling="auto"></iframe>
						</div>
						<div class="clear"></div>
					</td>
					<td id="middleArea" class="content_l"
						style="width: 16px; display: none;"></td>
					<td width="*" valign="top" style="padding:0px 10px 0px 0px;">
						<div id="leftCTR"
							onclick="javascript:showM('leftArea','middleArea');">
							<span title="收缩面板" class="gnmenu_close"></span>
						</div>
						<div id="mainPanle" border="false" region="center"
							style="padding: 0px; overflow: hidden; z-index: 10;">
							<iframe name="tabsFrame" id="tabsFrame" scrolling="no"
								frameborder="0" allowtransparency="true" width="100%"
								height="100%" src="tabs.html"></iframe>
						</div>
						<!--页脚-->
						<div id="footbox" >
			                 <div class="foot">
	                            <div class="footerText">
									&copy; 2017-2018 技术支持：金建峰      联系方式：17330761601
	                            </div>
			                 </div>
			            </div>
					</td>
				</tr>
			</table>
		</div>

		<input type="hidden" name="txtAgentID" id="txtAgentID" value="$!user.loginname" />
		<input name="txtIp" id="txtIp" type="hidden" value="192.168.0.23" />
		<input name="txtPort" id="txtPort" type="hidden" value="22222" />

	</body>
</html>

<script language="JavaScript">
	function lock(){
	 top.Dialog.confirm("确定要锁屏吗，锁屏后只有重新输入密码才能解除。", function() {
		 openLockWindow();

	 });
	}
	
	function initSelect(){
		#foreach($modules in $moduleslist)
		$("#appname").append("<option value=\"$!modules.id\">$!modules.name</option> ");
		#end
		$("#appname").combobox({
			editable:false,
			onChange:function(newValue,oldValue){
				if(oldValue!=""&&newValue!=oldValue){
					jQuery.ajax({
			   		 	type: 'POST',
			   			url : "${base}/private/reload" ,
			   			data : {"resid":newValue},
			   			success : function (res) {
			   				if(res=="true"){
			   					 window.location.reload();
			   				}
			   				return false;

			   			},
			   			fail : function(res) {
			   				Dialog.alert("系统错误?!");
			   			}
			   		});
				}
			 }
			});
		$("#appname").combobox("select", "$!resid");
	}
	function validate(){
		$!validate
	}
	function unlock(){
		if($DW.Verify.hasError()){
       	  	return;
         }
		jQuery.ajax({
   		 	type: 'POST',
   			url : "${base}/private/dounlock" ,
   			data : "password="+encode64($DW.$("#password").val()),
   			success : function (res) {
   				if(res=="true"){
   					$D.close();
   					window.location.reload();
   				}else{
   					Dialog.alert(res);
   				}
   				return false;

   			},
   			fail : function(res) {
   				Dialog.alert("系统错误?!");
   			}
   		});
	}
	function openLockWindow(){
		var d = new top.Dialog("lock");
        d.Width = 360;
        d.Height = 160;
        d.Title = "系统锁屏";
        d.URL = "${base}/private/dolock";
        d.OKEvent = function(){
        	unlock();
        };
        d.CancelEvent = function(){
        	top.location.replace('logout');
        };
        d.onLoad = function() {
        	//$DW.$Z("password").focus();
        }
        d.ButtonCenter=true;
        d.show();
        d.OKButton.value=" 解锁 ";
        d.CancelButton.value=" 注销 ";
        $.post("${base}/private/dolock");

	}
    function changePassword(){
        var d = new top.Dialog("ChangePassword");
        d.Width = 390;
        d.Height = 380;
        d.Title = "个人信息";
        d.URL = "${base}/private/sys/user/info";
        d.OKEvent = function(){
        	doSave();
        };
        d.onLoad = function() {
            $DW.$Z("oldpassword").focus();

        }
        d.show();
    }
    
    function xgmm(){
        var d = new top.Dialog("xgmm");
        d.Width = 500;
        d.Height = 380;
        d.Title = "修改密码";
        d.URL = "${base}/private/sys/user/xgmm";
        d.OKEvent = function(){
        	doSave();
        };
        d.onLoad = function() {
            $DW.$Z("oldpassword").focus();

        }
        d.closable=false;
        d.CancelButton=false;
        d.show();
    }
    
    function doSave(){
    	if($DW.Verify.hasError()){
    		  return;
    	     }
    	if($DW.$("#loginname").val()!="$!curuser.loginname"){
	    	jQuery.ajax({
	    		url : "${base}/private/sys/user/ajaxname",
	    		data : $DW.$("#form1").serialize(),
				type: "POST",
	    		success : function (res) {
	    			if(res=="true"){
	    				Dialog.alert("用户名已存在");
	    				return;
	    			}else{
		    		    doit();
	    			}
	    		},
	    		fail : function(res) {
	    			Dialog.alert("系统错误?!");
	    		}
	    	});
    	}else{
    		doit();
    	}



    }
    function doit(){
    	if ($DW.$("#oldpassword").val()=="")
	    {
	    	top.Dialog.alert("请输入密码！");
	    	$DW.$("#oldpassword").focus();
			 return ;
	    }
	    if ($DW.$("#password2").val()!="" && $DW.$("#password").val()=="")
	    {
	         top.Dialog.alert("请输入重复新密码！");
	         $DW.$("#password").focus();
			 return ;
	    }
    	jQuery.ajax({
		 	type: 'POST',
			url : "${base}/private/sys/user/updateInfo" ,
			data : $DW.$("#form1").serialize(),
			success : function (res) {
				if(res=="relogin"){
					$D.close();
					top.Dialog.confirm("用户名或密码已修改，请重新登陆！",function(){
						window.top.location.href="${base}/private/login";
					},function(){
						window.top.location.href="${base}/private/login";
					});
				}else if(res=="true"){
					$D.close();
					Dialog.alert("修改成功！");
				}else if(res=="error"){
					Dialog.alert("原密码不正确！");
				}else{
					Dialog.alert("修改失败！");
				}
			},
			fail : function(res) {
				Dialog.alert("系统错误?!");
			}
		});
    }
    function logout()
    {
       top.Dialog.confirm("你确认要退出系统吗？", function() {
        top.location.replace('logout');
         });
    }
    function dochange(id, url, menuname)
    {
        if (url == '' || url == 'null')
        {
            document.getElementById("leftFrame").src='${base}/private/left?sys_menu=' + menuname + '&sys_menuid=' + id + '&sys_random=' + Math.random();
            setTimeout(function(){
            	var title="欢迎使用";
            	var title_fr="信用主体信息";
            	var title_xz="欢迎使用";
            	//判断用户是否具有领导角色
            	if($!user.rolelist.contains("506")){
             		document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/zmtj");
            	}
            	//将桌面统计绑定到综合管理信息栏
            	if(id=='00060002'){
	            	title_xz=title;
	            	closeOtherTab(title_f);
	            	//判断用户是否具有领导角色
	            	if($!user.rolelist.contains("506")){
	            		document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/zmtj");
	            	}else{
	            		document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome.html");
	            	}
                }else if(id=='00080010'){//地质灾害危险性评估
                	title_xz=title_fr;
                	closeOtherTab(title);
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/zzxyxx?xy_type=00050005");
                }else if(id=='00080013'){//地质灾害治理
                	closeOtherTab(title);
                	title_xz=title_fr;
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/zzxyxx?xy_type=00070002");
                }else if(id=='00080005'){//土地价格评估
                	closeOtherTab(title);
                	title_xz=title_fr;
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/zzxyxx?xy_type=00050001");
                }else if(id=='00080006'){//土地规划服务
                	title_xz=title_fr;
                	closeOtherTab(title);
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/zzxyxx?xy_type=00050002");
                }else if(id=='00080007'){//土地登记代理服务
                	title_xz=title_fr;
                	closeOtherTab(title);
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/zzxyxx?xy_type=00050003");
                }else if(id=='00080008'){//矿业权价款评估
                	title_xz=title_fr;
                	closeOtherTab(title);
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/zzxyxx?xy_type=00050004");
                }else if(id=='00080012'){//农村土地整治
                	title_xz=title_fr;
                	closeOtherTab(title);
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/zzxyxx?xy_type=00070001");
                }else if(id=='00080014'){//矿山地质环境治理
                	title_xz=title_fr;
                	closeOtherTab(title);
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/zzxyxx?xy_type=00070003");
                }else if(id=='00080015'){//实施地质勘察信用
                	closeOtherTab(title);
                	title_xz=title_fr;
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/zzxyxx?xy_type=00070004");
                }else if(id=='00080004'){//测绘地理市场信用
                	closeOtherTab(title);
                	title_xz=title_fr;
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/zzxyxx?xy_type=0006");
                }//以上是含资质信息的信用主体类型，以下是不含资质信息
                else if(id=='00080011'){//科技项目
                	title_xz=title_fr;
                	closeOtherTab(title);
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/htxyxx?xy_type=00050007");
                }else if(id=='00080001'){//土地市场信用管理
                	title_xz=title_fr;
                	closeOtherTab(title);
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/htxyxx?xy_type=0004");
                }else if(id=='00080003'){//采矿权市场
                	title_xz=title_fr;
                	closeOtherTab(title);
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/htxyxx?xy_type=00030002");
                }else if(id=='00080002'){//探矿权市场
                	title_xz=title_fr;
                	closeOtherTab(title);
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/htxyxx?xy_type=00030001");
                }else if(id=='00080009'){//国土资源监测
                	title_xz=title_fr;
                	closeOtherTab(title);
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/htxyxx?xy_type=00050006");
                }else if(id=='00080016'){//复垦信用
                	title_xz=title_fr;
                	closeOtherTab(title);
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/htxyxx?xy_type=0009");
                }else if(id=='00080017'){//行政处罚
                	title_xz=title_fr;
                	closeOtherTab(title);
                	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome/htxyxx?xy_type=0008");
                }else{
                	title_xz=title;
                	closeOtherTab(title_fr);
                 	document.getElementById("tabsFrame").contentWindow.addWelcomeTab(title_xz,"${base}/private/welcome.html");
                }
                $(window.frames["tabsFrame"].document).find("#tabs").tabs('select',title_xz);//默认选中
              },500)
        }
        else
        {
            if (url.indexOf("?") > 0)
            {
                document.getElementById("leftFrame").src='${base}' + url + '&sys_menu=' + menuname + '&sys_menuid=' + id + '&sys_random=' + Math.random();
            }
            else
            {
                document.getElementById("leftFrame").src='${base}' + url + '?sys_menu=' + menuname + '&sys_mneuid=' + id + '&sys_random=' + Math.random();
            }
        }
    }
	function closeOtherTab(closenames){
		var arr=closenames.split(",");
		for(var i=0;i<arr.length;i++){
			document.getElementById("tabsFrame").contentWindow.closeTab(arr[i])
		}
	}
    var oldid = 1;
    var imag2 = '${base}/images/private/sys/index_15.gif';
    function dochangeimg(objid)
    {
        try
        {
            /* if (objid == oldid)
            {
                return;
            }
            else
            {
                var a = document.getElementById("aamenuid" + objid);
                a.style.color = '#EAFF00';
                var objimg = eval('document.all.menuid' + objid);
                objimg = eval('document.all.menuid' + oldid);
                var olda = document.getElementById("aamenuid" + oldid);
                olda.style.color = '';
                objimg.background = imag2;
                oldid = objid;
            } */
			jQuery(".Nmenu_menu a").removeClass("select");
			jQuery("#menuid" + objid).addClass("select");
        }
        catch(exception)
        {

        }
    }

	var isOpen = true;
    function getOnline()
    {
        jQuery.ajax({
			url : "${base}/private/online?loginname=$!curuser.loginname&sys_random=" + Math.random(),
			success : function (res) {
				if(res==-2){
					if(isOpen){
						isOpen = false;
						top.Dialog.confirm("用户登陆已失效，请重新登陆！",function(){
							window.top.location.href="${base}/private/login";
						},function(){
							window.top.location.href="${base}/private/login";
						});
					}
				}else if (res > 0) {
					$('#dvonline').html("您好，<span>$!curuser.realname&nbsp;</span></br>当前在线 <span>" + res + "</span> 人");
				} else {
					$('#dvonline').html("您好，<span>$!curuser.realname&nbsp;</span></br>当前在线 <span>1</span> 人");
				}
				return false;
			},
			fail : function(res) {
				Dialog.alert("系统错误?!");
			}
		});

        window.setTimeout('getOnline()', 1000 * 60 * 60 );
    }

  	//打开消息显示页面
	function toNoticesPage(){
		document.getElementById("tabsFrame").contentWindow.addTab("我的消息","${base}/private/msg/msgInfo/showNotices?sys_menu=我的消息 &sys_random="+ Math.random());
	}
	//ajax查询目前该用户的消息数量
	function searchNotice(){
		jQuery.ajax({
   		 	type: 'POST',
   			url : "${base}/private/searchNotics" ,
   			success : function (res) {
   				if(res!="0"){
   					$("#notic_div").show();
   					$("#notic_a").text(res);
   				}else{
   					$("#notic_div").hide()
   				}
   				return false;

   			},
   			fail : function(res) {
   				Dialog.alert("系统错误?!");
   			}
   		});
	}

    //自动查询消息数量
    function AutoShowNotice(){
		//window.setInterval("searchNotice()",1000 * 60 * 3);//每10分钟查询一次公告更新;600000
	}
    
    //验证密码强度
    function yzPassword(){
    	jQuery.ajax({
   		 	type: 'POST',
   			url : "${base}/private/yzPassword" ,
   			success : function (res) {
   				try{                      
                    var v_pw = res;
                    var patrn_shuzi=/^[0-9]$/;
                    var patrn_zimu=/^[a-z]|[A-Z]$/;
                    var patrn_zifu=/^((?=[\x21-\x7e]+)[^A-Za-z0-9])/;
                    var flag=0;
                    var s = v_pw.split('');

                    for(var i=0;i <s.length;i++){
                      if (patrn_shuzi.exec(s[i])) {
                        flag = flag+1;
                        break;
                      }
                    }
                    for(var i=0;i <s.length;i++){
                      if (patrn_zimu.exec(s[i])) {
                        flag = flag+1;
                        break;
                      }
                    }
                    for(var i=0;i <s.length;i++){
                        if (patrn_zifu.exec(s[i])) {
                          flag = flag+1;
                          break;
                        }
                      }
                    if (flag != 3) {
                    	xgmm();
                    }
                    
				} catch (ex) {
					Dialog.alert("校验规则错误");
				}
   			},
   			fail : function(res) {
   				Dialog.alert("系统错误?!");
   			}
   		});
    }

    Page.onLoad(function() {
    	/* yzPassword(); */
   	 validate();
   	 getOnline();
   	 initSelect();
   	AutoShowNotice();//自动查询消息数量

   });
	function showM(leftDIV,midDIV){
		if(document.getElementById(leftDIV).style.display=="none"){
			document.getElementById(leftDIV).style.display="";
			document.getElementById(midDIV).style.display="none";
			$("#leftCTR").css('left','200px')
			$("#leftCTR").find('span').removeClass("gnmenu_open")
			$("#leftCTR").find('span').addClass("gnmenu_close")
			$("#"+midDIV).click(function(){$("#leftCTR").click();});
		}else{
			document.getElementById(leftDIV).style.display="none";
			document.getElementById(midDIV).style.display="";
			$("#leftCTR").css('left','5px')
			$("#leftCTR").find('span').removeClass("gnmenu_close")
			$("#leftCTR").find('span').addClass("gnmenu_open")
			$("#"+midDIV).click(function(){$("#leftCTR").click();});
		}
		/*document.getElementById("leftCTR").click(function(){
			alert(1)
			//$("#leftArea").hide();
		})*/
	}
	// 样式表切换
	function openChangeStyle(){
		var d = new top.Dialog("changeStyle");
        d.Width = 800;
        d.Height = 400;
        d.Title = "修改页面样式";
        d.URL = "${base}/private/toChangeStyle";
        d.OKEvent = function(){
        	updateStyleSave();
        };
        d.ButtonCenter=true;
        d.show();
        d.OKButton.value=" 修改 ";
        d.CancelButton.value=" 取消 ";
	}

	//打开系统帮页面
	function openSystemHelp(){
		var url='${base}/private/help?sys_menu=系统使用帮助&sys_random=' + Math.random();
  	   	var title='系统使用帮助';
  	   	/* var parameters='height=700px, width=1150px, scrollbars=no, resizable=no';
  	   	openwindow(url, title, parameters); */
  	  openWin3(url,title,"1150","700");
	}
      function updateStyleSave(){
		$DW.Page.MinMessage.Show({
			text: '正在替换',
			type: 'load'
		});
       	jQuery.ajax({
       		type: 'POST',
           	url : "${base}/private/doChangeStyle",
           	data : $DW.$("#form1").serialize(),
           	success : function (res) {
	     		if(res="true"){
	      			$D.close();
          			Dialog.alert("修改成功！",function(){
          				 location.reload();
          			});
	       		}else{
	           		Dialog.alert("修改失败！");
	           	}
           		$DW.Page.MinMessage.Hide();
           			return false;
           	},
          	fail : function(res) {
           		Dialog.alert("系统错误?!");
         	}
      });
   }

</script>
