<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>$!app_name</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type='text/javascript'>
        var CONTEXTPATH = '${base}';
        var stylePath = '$!stylename';
    </script>
    <link href="${base}/include/css/blue/style.css" rel="stylesheet" type="text/css" />
    <link href="${base}/include/css/page.css" rel="stylesheet" type="text/css" />
    <link href="${base}/private/ratifyFollow/css/$!stylename/style.css" rel="stylesheet" type="text/css" />
    <script src="${base}/include/js/main.js"></script>
    <script src="${base}/include/js/string.js"></script>
    <script src="${base}/include/js/jquery.easyui.min.js"></script>
    <link href="${base}/include/controls/my97/skin/WdatePicker.css" rel="stylesheet" type="text/css"/>
    <script language="javascript" type="text/javascript" src="${base}/include/controls/my97/WdatePicker.js"></script>
    <script>
        var d = null;
        function ht(){
            $("#hideDIV").attr("style","");
        }
        var ztMap = $!ztMap;
        function toAddht(){
            var xyml = $("#xy_type").val();
            var ctype = 1;
            d = new Dialog("Addht");
            d.Width = 900;
            d.Height = 450;
            d.Title = "关联项目";
            d.URL = "${base}/private/formyy/selectHt?xyml="+xyml+"&type="+ctype;
            
            d.OKEvent = function(){
                if($DW.doSave()){
                    var ht_ids = $DW.$("#ids").val();
                    var ht_names = $DW.$("#htnames").val();
                    var xyzt_name = $DW.$("#xyzts").val();
                    var xyzt_ids = $DW.$("#xyztids").val();
                    $("#contract_id").val(ht_ids);
                    $("#ht_name").val(ht_names);
                    $("#name").val(xyzt_name);
                    $("#xyztid").val(xyzt_ids);
                    $("#xwtr").show();
                    if(xyml=="00070001"||xyml=="00070004"){
                    var httype = $DW.$("#httypes").val();
                    $("div[name='xwdiv']").hide();
                    $("div[id='xwdiv_"+httype+"']").show();
                    }
                    $D.close();
                    toAddXyzt(xyzt_ids);
                    if($("input[name=checkbox_qx]:checked").val() == "00200001"){
                		checkCount("00200001");
                	}
                }
            }
            d.show();
        }
        function toAddXyzt(xyzt_ids){
        	jQuery.ajax({
                type: 'POST',
                url : "${base}/private/sxcj/tofindXyzt?xyzt_ids="+xyzt_ids,
                dataType : "json",
                success : function (res) {
                    $.each(res,function(n,array){
                        $("#xyzt_type").val(ztMap[array.type]);
                        if(array.code !=null && array.code !=""){
                            $("#code").val(array.code);
                        }else{
                            $("#code").val(array.zzjgdm);
                        }
                    })
                },
                fail : function(res) {
                    Dialog.alert("系统错误?!");
                }
            });
        }
        function toAddXKZH(xytype){
        	var ctype = 1;
        	d = new Dialog("Addht");
        	d.Width = 900;
        	d.Height = 450;
        	d.Title = "关联项目";
        	if(xytype=="00030001"){
        	d.URL = CONTEXTPATH + "/private/formyy/selectTKXKZH?type="+ctype
        	}else{
        	d.URL = CONTEXTPATH + "/private/formyy/selectXKZH?type="+ctype;
        	}
        	d.OKEvent = function(){
        		if($DW.doSave()){
        			var ht_ids = $DW.$("#ids").val();
        			var ht_names = $DW.$("#htnames").val();
        			var xyzt_name = $DW.$("#xyzts").val();
        			var xyzt_ids = $DW.$("#xyztids").val();
        			var bjhs = $DW.$("#bjhs").val();
        			var names = xyzt_name.split("☆☆");
        			$("#contract_id").val(ht_ids);
                    $("#ht_name").val(ht_names);
                    $("#name").val(names[0]);
                    $("#xyztid").val(xyzt_ids);
                    $("#xwtr").show();
        			$D.close();
        			toAddXyzt(xyzt_ids);
        		}
        	}
        	d.show();
        }
        function closeSub(){
            d.close();
        }
        
        function toAddxzcf(xytype){
        	var ctype = 1;
        	d = new Dialog("Addht");
        	d.Width = 900;
        	d.Height = 450;
        	d.Title = "关联项目";
        	d.URL = CONTEXTPATH + "/private/formyy/selectXzcf?type="+ctype;
        	d.OKEvent = function(){
        		if($DW.doSave()){
        			var ht_ids = $DW.$("#ids").val();
        			var ht_names = $DW.$("#htnames").val();
        			var xyzt_name = $DW.$("#xyzts").val();
        			var xyzt_ids = $DW.$("#xyztids").val();
        			var names = xyzt_name.split("☆☆");
        			$("#xzcf_id").val(ht_ids);
                    $("#ht_name").val(ht_names);
                    $("#name").val(names[0]);
                    $("#xyztid").val(xyzt_ids);
                    $("#xwtr").show();
        			$D.close();
        			toAddXyzt(xyzt_ids);
        		}
        	}
        	d.show();
        }
        
        //无合同添加信用主体    
        function toAddfr(){
            var ctype = 1;
            var d = new Dialog("Addfr");
            d.Width = 900;
            d.Height = 450;
            d.Title = "添加信用主体";
            d.URL = "${base}/private/jlxx/toAddfr?frbutton=1&ctype="+ctype;
            d.OKEvent = function(){
                if($DW.doSave()){
                    var ids = $DW.$("#checkids_id").val();
                    var names = $DW.$("#checkids_name").val();
                    var types = $DW.$("#checkids_type").val();
                    var codes = $DW.$("#checkids_code").val();
                    var code = codes.split(",");
                    $("#name").val(names);
                    $("#xyzt_id").val(ids);
                    $("#xyzt_type").val(ztMap[types]);
                    $("#code").val(code[0]);
                    $("#xwtr").show();
                    $D.close();
                    if($("input[name=checkbox_qx]:checked").val() == "00200001"){
                		checkCount("00200001");
                	}
                }
            }
            d.show();
        }

        function change1(){
            var s = Page.getValue("subtype1");
            if(s == 5){
                $("#tr_sx1").attr("style","");
            }
        }

        $(document).ready(function() {
            $(".radioItem").change(function() {
                var selectedvalue = $("input[name='local']:checked").val();
                if (selectedvalue == 0) {
                    $("#tbody_yht").show();
                    $("#zt_img").attr("style","display:none");
                    $("#ht_name").attr("verify","合同名称|NotNull");
                    $("#name").attr("placeholder","");
                } else {
                    $("#tbody_yht").hide();
                    $("#zt_img").attr("style","vertical-align:middle;cursor: pointer;");
                    $("#ht_name").attr("verify","");
                    $("#name").attr("placeholder","点击右边图标即可添加");
                }
            });
        });

        var oldcheckboxVal = "";
        function checkboxOnclick(){
            $("input[name='checkbox']").click(function() {
            $("#qxtr_other").hide();
            $("#cstr_other").hide();
            $("#sxqx_other").val("");
            $("#cjcs_other").val("");
            $("#checkbox_other").attr("checked",false);
                var Source = window.event.srcElement;//指向触发事件的元素
                var arr_checkbox = document.getElementsByName("checkbox");
                for(var i=0;i<arr_checkbox.length;i++){
                    if($("input[name='checkbox']:checked").length > 1){
//                            Dialog.alert("此处只能选择一项");
                        $("input[name='checkbox']").attr("checked",false);
                        //对当前点击的checkbox置空
                        Source.checked = true;
                    }
                    //checkbox不为空
                    if($("input[name='checkbox']:checked").length == 0){
                        Source.checked = true;
                    }
                    var a = arr_checkbox[i].value;
                    if(arr_checkbox[i].checked == true){
                        if(a=="0000"){//其他
                        	$("#qxtr_other").show();
                            $("#cstr_other").show();
	                        $("#qxtr").hide();
	                        $("#yt_tr").hide();
	                        $("#cstr").hide();
	                        $("#yjtr").hide();
                        }else{
	                        $("#qxtr").show();
	                        addqx(a);
                        }
                    }
                    if(arr_checkbox[i].checked == false){
                        $("#span_qx"+a+"").html("");
                    }
                }

            });
        }
        //添加失信情形
        function addqx(id){
            $.ajax({
                type: "post",
                url : "${base}/private/sxcj/sxqxAjax?sxxwid="+id ,
                dataType : "json",
                success : function (res) {
                    var qx = "";
                    var old_name = "";
                    $.each(res,function(n,array){
                        if(old_name != array.sxqx){
                            old_name = array.sxqx ;
                            qx += "<span id='span_qx"+id+"'><input style='vertical-align: middle;' type='checkbox' id='checkbox_qx"+id+"' name='checkbox_qx' onclick='addcs("+array.cjcs+");' value='"+array.id+"'/><span>"+array.sxqx+"</span></br></span>";
                        }
                    })
                    $("#qx_td").html(qx);
                }
            });
        }
        
        //添加惩戒措施
        function addcs(cjcs){
            var Source = window.event.srcElement;//指向触发事件的元素
            var id = Source.value;//获取当前点击框value
            var bz = $("#bz1").val();
            
            var arr_checkbox = document.getElementsByName("checkbox_qx");
            //单选 
            if(bz == 0){
                for(var i=0;i<arr_checkbox.length;i++){
                    var a = arr_checkbox[i].value;
                    if($("input[name=checkbox_qx]:checked").length > 1){
                        $("input[name='checkbox_qx']").attr("checked",false);
                        //对当前点击的checkbox置空
                        Source.checked = true;
                    }
                }
            }
            
            for(var i=0;i<arr_checkbox.length;i++){
                if(arr_checkbox[i].checked == true){
                	var checkbox_value = Source.value;
                	//判断是否为需要显示约谈次数
                	if(checkbox_value == "00200001"){
                		checkCount(checkbox_value);
                	}else{
                		$("#yt_tr").attr("style","display:none");
                		$("#yt_date").attr("verify","");
                	}
                    var text = "";//单选存储
                    text = $("input[name=checkbox_qx]:checked").next().text();
                    $("#sxqx_name").val(text);
                    if(cjcs==1){
	                    $.ajax({
	                        type: "post",
	                        url : "${base}/private/sxcj/cjcsAjax?sxqxid="+id,
	                        dataType : "json",
	                        data : $("#form1").serialize(),
	                        success : function (res) {
	                            var cs = "";
	                            $.each(res,function(n,array){
	                                cs += "<span id='span_cs"+id+"'><input style='vertical-align: middle;' type='checkbox' id='checkbox_cs"+id+"' name='checkbox_cs' value='"+array.id+"'/>"+array.cjcs+"</br></span>";
	                            })
	                            $("#cs_td").html(cs);
	                        }
	                    });
                    }else{
                    	
                    }
                    $.ajax({
                        type: "post",
                        url : "${base}/private/sxcj/yjAjax?id="+id ,
                        dataType : "json",
                        success : function (res) {
                            var yj = "";
                            var yj_name = "";
                            var sxyj = "";
                            $.each(res,function(n,array){
                                if(yj_name != array.name) {
                                    yj_name = array.name;
                                    if(array.yj == null || array.yj == " "){
                                    	sxyj = "暂无";
                                    }else{
                                    	sxyj = array.yj;
                                    }
                                    yj += "<span id='span_yj" + id + "'>" + sxyj + "</br></span>";
                                }
                            })
                            $("#yj_td").html(yj);
                        }
                    });
                }
                if(arr_checkbox[i].checked == false){
                    $("#span_cs"+a+"").html("");
                }
            }
            if(cjcs==1){
	            $("#cstr").show();
	            $("#cstr_other").hide();
            }else{
            	$("#cstr").hide();
	            $("#cstr_other").show();
            }
            $("#yjtr").show();
        }
		
        //查询约谈次数
        function checkCount(sxqxid){
        	var xyzt_id = $("#xyzt_id").val();
        	$.ajax({
                type: "post",
                url : "${base}/private/sxcj/checkCount?sxqxid="+sxqxid+"&xyzt_id="+xyzt_id,
                success : function (res) {
                    $("#yt_td").text(res);
                    $("#yt_tr").attr("style","display:");
                    $("#yt_date").attr("verify","约谈时间时间|NotNull");
                }
            });
        }
        
        function doSave(){
            var checkbox = $("input[name=checkbox]:checked").val();
            if(checkbox!="0000"){
            	$("#sxqx_other").removeAttr("verify");
            	$("#cjcs_other").removeAttr("verify");
            }
            if(Verify.hasError()){
                return ;
            }
            if($("#unit").val()==""){
                Dialog.alert("请选择失信惩戒单位！",function(){
                    $("#unit").focus();
                });
                return ;
            }
            var start_date = $("#start_date").val();
            var end_date = $("#end_date").val();
            if($("input[name=checkbox]:checked").length == 0){
               Dialog.alert("请选择失信行为");
               return;
            }
            if(checkbox!="0000"){
	            if($("input[name=checkbox_qx]:checked").length == 0){
	               Dialog.alert("请选择失信情形");
	               return;
	            }
	            if($("input[name=checkbox_cs]")[0]!=undefined&&$("input[name=checkbox_cs]:checked").length == 0){
	               Dialog.alert("请选择惩戒措施");
	               return;
	            }
            }
            if(end_date != ""){
	            if(start_date > end_date){
	                Dialog.alert("被惩罚时限结束时间不得小于开始时间");
	                return;
	            }
            }

            var checkbox_str = [];
            $('input[name="checkbox"]:checked').each(function(){
                checkbox_str.push($(this).val());
            });
            var checkbox_qx_str = [];
            $('input[name="checkbox_qx"]:checked').each(function(){
                checkbox_qx_str.push($(this).val());
            });
            var checkbox_cs_str = [];
            $('input[name="checkbox_cs"]:checked').each(function(){
                checkbox_cs_str.push($(this).val());
            });
            if(checkbox_str.length == 0){
            	$("#sxxw_other").val("0000");
            }
            $("#sxxw_id").val(checkbox_str);
            $("#sxqx_id").val(checkbox_qx_str);
            $("#cjcs_id").val(checkbox_cs_str);
            jQuery.ajax({
                type: 'POST',
                url : "${base}/private/sxcj/addSave" ,
                data : $("#form1").serialize(),
                success : function (res) {
                    if(res){
                        Dialog.alert("添加成功！",function(){
                        	refreshloadDataTab();
                        });
                    }else{
                        Dialog.alert("添加失败！");
                    }
                    return false;
                },
                fail : function(res) {
                    Dialog.alert("系统错误?!");
                }
            });
        }

    jQuery(document).ready(function() {
        customHeightSet();
    });
    window.onresize = function() {
        customHeightSet();
    }
        window.onload = function(){
            checkboxOnclick();
           // $("#xwtr").hide();
            $("#qxtr").hide();
            $("#cstr").hide();
            $("#yjtr").hide();
			customHeightSet();
        }
        
    </script>
</head>
<body leftmargin="0" topmargin="0">
<form name='form1' id="form1" method='post'>
    <input type="hidden" name="sxqx_name" id="sxqx_name"/>
    <input type="hidden" name="id" id="id" value="$!obj.id">
    <input type="hidden" name="sxxw_id" id="sxxw_id">
    <input type="hidden" name="sxqx_id" id="sxqx_id">
    <input type="hidden" name="cjcs_id" id="cjcs_id">
    <input type="hidden" name="xyzt_id" id="xyzt_id">
    <input type="hidden" name="xzcf_id" id="xzcf_id" />
    <input type="hidden" name="xyztid" id="xyztid"/>
    <input type="hidden" name="type" id="type" value=" "/>
    <input type="hidden" name="xy_type" id="xy_type" value="$!xytype"/>
    <input type="hidden" name="tablekey" id="tablekey" value="$!tablekey"/>
    <input type="hidden" name="contract_id" id="contract_id">
    <div class="pageM viewpage pageAdd" id="pageScroll">
        <table width="98%" border="0" align="center" cellpadding="0" cellspacing="0" class="table_titlebk">
            <tr>
                <td class="table_title" align="center">
                    失信惩戒信息
                </td>
            </tr>
        </table>
        <table width="98%" border="0" cellpadding="0" cellspacing="3" class="table_auto table_nrbk">
           #if($tablekey&&(("$!xytype"!="00070004")||("$!xytype"=="00070004"&&$!sxxwlist.size()==1&&"$!sxxwlist.get(0).ht_type"!=""))||"$!xytype"=="0008")
            <tr>
                <td align="right">是否关联项目：</td>
                <td colspan="3">
                    <input type="radio" class="radioItem" name="local" id="local"  value="0" checked="checked" />是
                    <input type="radio" class="radioItem" name="local" id="local"  value="1" />否
                </td>
            </tr>

            <!-- 涉及合同模块 -->
            <tbody id="tbody_yht" style="display: ">
            <tr>
                <td align="right">关联项目：</td>
                <td algin="left" colspan="3"><input type="text" name="ht_name" id="ht_name" size="30" readonly maxlength="50" placeholder="点击右边图标即可添加" verify="合同名称|NotNull" class="readonlyText"/>
                    &nbsp;<img src="${base}/include/img/cz_find.png" id="ht_img" name="ht_img" style=" vertical-align:middle;cursor: pointer;" #if("$!xytype"=="00030002"||"$!xytype"=="00030001")onclick="toAddXKZH('$!xytype');"#elseif("$!xytype"=="0008")onclick="toAddxzcf('$!xytype');"#else onclick="toAddht();"#end/>
                </td>
            </tr>
            </tbody>
            
            <tr>
                <td align="right">信用主体：</td>
                <td>
                    <input type="text" name="name" id="name" size="30" maxlength="40" readonly placeholder=""  verify="信用主体|NotNull" class="readonlyText"/>
                    &nbsp;<img src="${base}/include/img/cz_find.png" id="zt_img" name="zt_img" style=" vertical-align:middle;cursor: pointer;display:none;" onclick="toAddfr();"/>
                </td>
                <td align="right">信用主体类型：</td>
                <td><input type="text" id="xyzt_type" name="xyzt_type" size="20" readonly class="readonlyText"/></td>
            </tr>
            #else
            <tr>
                <td align="right">信用主体：</td>
                <td>
                    <input type="text" name="name" id="name" size="30" maxlength="40" readonly placeholder=""  verify="信用主体|NotNull"/>
                    &nbsp;<img src="${base}/include/img/cz_find.png" id="zt_img" name="zt_img" style=" vertical-align:middle;cursor: pointer;" onclick="toAddfr();"/>
                </td>
                <td align="right">信用主体类型：</td>
                <td><input type="text" id="xyzt_type" name="xyzt_type" size="20" readonly class="readonlyText"/></td>
            </tr>
            #end
            <tr>
                <td align="right"><p id="p0" style="display: ">统一社会信用代码：</p><p id="p1" style="display:none ">身份证号：</p><p id="p2" style="display:none ">组织机构代码：</p></td>
                <td algin="left" colspan="3"><input type="text" readonly name="code" id="code" size="30" maxlength="50" class="readonlyText"/></td>
            </tr>

            <tr>
                <td align="right" width="15%">惩戒机构：</td>
                <td width="30%">
                	<input type="hidden" id="unit" name="unit" value="$!unit"/>
                    $!unitname
                </td>
                <td align="right" width="15%">惩戒作出时间：</td>
                <td width="*%"><input class="Wdate" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',maxDate:'%y-%M-%d'});" value="$!today" name="discipline_date" id="discipline_date" size="20" maxlength="50" verify="惩戒做出时间|NotNull"/></td>
            </tr>

            <tr>
                <td align="right">被惩戒时限：</td>
                <td colspan="3">
                    <input class="Wdate" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',minDate:'#F{$dp.$D(\'discipline_date\')}',maxDate:'%y-%M-%d'});" name="start_date" id="start_date" value="$!today" size="20" maxlength="50"  verify="开始时间|NotNull"></input>&nbsp;&nbsp;至&nbsp;
                    <input class="Wdate" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',minDate:'#F{$dp.$D(\'start_date\')}'});" name="end_date" id="end_date" size="20" maxlength="50"></input>
                </td>
            </tr>

            <tr id="xwtr">
                <td align="right" valign="top">失信行为：</td>
                <td colspan="3">
                    #foreach($!obj in $!sxxwlist)
                    <div name='xwdiv' id=xwdiv_$!httyMap.get("$!obj.ht_type")>
                    <input style="vertical-align:middle;" type="checkbox" id="checkbox$!obj.id" name="checkbox" value="$!obj.id"/>$!obj.sxxw</br>
                    <input type="hidden" id="bz$velocityCount" name="bz" value="$!obj.bz"/>
                    </div>
                    #end
                </td>
            </tr>
            
            <tr id="qxtr">
                <td align="right" valign="top">失信情形：</td>
                <td colspan="3" >
                    <span id="qx_td"></span>
                </td>
            </tr>
            <tr id="qxtr_other" style="display: none;">
                <td align="right" valign="top">失信情形：</td>
                <td colspan="3" >
                	<textarea rows="5" cols="100" name="sxqx_other" id="sxqx_other" verify="失信情形|NotNull"></textarea>
                </td>
            </tr>
			<tr id="yt_tr" style="display:none">
				<td align="right">约谈时间：</td>
                <td><input class="Wdate" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',maxDate:'%y-%M-%d'});" name="yt_date" id="yt_date" size="20" maxlength="50" verify=""/></td>
				<td align="right" valign="top">已约谈次数:</td>
				<td id="yt_td"></td>
			</tr>
            <tr id="cstr">
                <td align="right" valign="top">惩戒措施：</td>
                <td colspan="3" id="cs_td">

                </td>
            </tr>
            <tr id="cstr_other" style="display: none;">
                <td align="right" valign="top">惩戒措施：</td>
                <td colspan="3">
                	<textarea rows="5" cols="100" name="cjcs_other" id="cjcs_other" verify="惩戒措施|NotNull"></textarea>
                </td>
            </tr>
            <tr id="yjtr">
                <td align="right" valign="top">惩戒依据：</td>
                <td colspan="3" id="yj_td">

                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="pageBtnarea">
            <input class="button" type="button" name="btnOk" value="提交"
                   onclick="doSave()" />
            <input class="button" type="button" name="btnOk" value="关闭"
                   onclick="window.close();" />
    </div>
</form>
</body>
</html>