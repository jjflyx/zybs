<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<title>$!app_name</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<script type='text/javascript'>
		var CONTEXTPATH = '${base}';
		var stylePath = '$!stylename';
	</script>
	<link href="${base}/private/ratifyFollow/css/$!stylename/style.css" rel="stylesheet" type="text/css" />
	<script src="${base}/include/js/main.js"></script>
	<script src="${base}/include/js/string.js"></script>
	<!--<link href="${base}/include/css/themes/gray/easyui.css" rel="stylesheet" type="text/css" />-->
	<script src="${base}/include/js/jquery.easyui.min.js"></script>
	<script>
		var units=0;
		var index=0;
		var typesvalues=new Array(units);
		function showtype(idvalue){
			if(idvalue!=""){
				for(var i=0;i<typesvalues.length;i++){
					if(typesvalues[i][0]==idvalue){
						selected(document.form1.unittype,typesvalues[i][1]);
						break;
					}
				}
			}else{
				selected(document.form1.unittype,'0');
			}
		}

		function gz_add(){
			var val = "当应履行义务 <span style='color:cornflowerblue;'>"+$("#b").find("option:selected").text()+
					" ["+$("#b").val()+"]</span> <span style='color:firebrick;'>["+$("#c").val()+"]</span> 实际履行义务 <span style='color:cornflowerblue;'>"+$("#d").find("option:selected").text()+
					" ["+$("#d").val()+"]</span>";
			$("#gz").html($("#gz").html()+val+"<br />");
			$("#yj_span").attr("style","color:red;");
			$("#table_name").attr("disabled","disabled");
			$("#rule").val($("#rule").val() +"@@"+$("#b").val()+"☆☆"+$("#c").val()+"☆☆"+$("#d").val());
		}

		function checkSelect(id,name){
			if($("#"+id).val()==0){
				Dialog.alert("请选择"+name,function(){
					$("#"+id).focus();
				});
				return false;
			}else{
				return true;
			}
		}

		function doSave(){
			if(Verify.hasError()){
				return ;
			}
			if(!checkSelect("xy_type","所属类别")){
				return;
			}
			if(!checkSelect("sxxw","失信行为")){
				return;
			}
			if(!checkSelect("sxqx","失信情形")){
				return;
			}
			if(!checkSelect("cjcs","惩戒措施")){
				return;
			}
			if(!checkSelect("table_name","指定表")){
				return;
			}
			if($("#rule").val().length==0){
				Dialog.alert("请添加预警规则!",function(){
					$("#b").focus();
				});
			}

			$("#rule").val($("#table_name").val()+$("#rule").val());
			$("#sxxw_id").val($("#sxxw").val());
			$("#sxqx_id").val($("#cjcs").val());
			Dialog.confirm("确定提交新预警规则?!",function(){
				jQuery.ajax({
					type: 'POST',
					url : "${base}/private/gtxt/rule/add" ,
					data : $("#form1").serialize(),
					success : function (res) {
						Dialog.alert("添加新预警规则成功",function(){
							window.opener.loadGrid();
							window.close();
						});
					},
					fail : function(res) {
						Dialog.alert("系统错误?!");
					}
				});
			});
		}

		function changeSelect(xyly,name,key){
			var xylx = $("#"+xyly).val();
			var key = $("#"+key).val();
			jQuery.ajax({
				type: 'POST',
				url : "${base}/private/gtxt/rule/getBreachInfoList" ,
				data : {"xylx":xylx,"name":name,"id":key},
				success : function (res) {
					var old_name = "";
					$("#"+name).html("<option value=\"0\">请选择</option>");
					if(name=="sxxw"){
						$("#sxqx").html("<option value=\"0\">请选择</option>");
						$("#cjcs").html("<option value=\"0\">请选择</option>");
					}else{
						$("#cjcs").html("<option value=\"0\">请选择</option>");
					}
					if(res.length > 0){
						var obj = eval('(' + res + ')');
						for(var i=0; i < obj.length; i++){
							if(old_name != obj[i].name) {
								$("#" + name).html($("#" + name).html() + "<option value='" + obj[i].id + "' >" + obj[i].name + "</option>");
								old_name = obj[i].name ;
							}
						}
					}
				},
				fail : function(res) {
					Dialog.alert("系统错误?!");
				}
			});

			if(name=="sxxw"){
				jQuery.ajax({
					type: 'POST',
					url : "${base}/private/gtxt/rule/getTableList" ,
					data : {"xylx_id":xylx},
					success : function (res) {
						if(res.length > 0){
							var obj = eval('(' + res + ')');
							$("#table_name").html("<option value=\"0\">请选择</option>");
							for(var i=0; i < obj.length; i++){
								$("#table_name").html($("#table_name").html() + "<option value='" + obj[i].tableid + "' >" + obj[i].formtitle + "</option>");
							}
						}
					},
					fail : function(res) {
						Dialog.alert("系统错误?!");
					}
				});
			}

		}

		function setTbaleOption(){
			jQuery.ajax({
				type: 'POST',
				url : "${base}/private/gtxt/rule/getTbaleOption" ,
				data : {"tableid":$("#table_name").val()},
				success : function (res) {
					if(res.length > 0){
						$("#tableid").val($("#table_name").val());
						var obj = eval('(' + res + ')');
						$("#b").html("<option value=\"0\">请选择</option>");
						$("#d").html("<option value=\"0\">请选择</option>");
						for(var i=0; i < obj.length; i++){
							if(obj[i].fieldname.indexOf("_y") > 0) { // _y结尾的表示是义务字段
								$("#b").html($("#b").html() + "<option value='" + obj[i].fieldname + "' >" + obj[i].fieldlabel + "</option>");
							}else if(obj[i].fieldname.indexOf("_s") > 0) { //_s结尾的表示实际履行字段
								$("#d").html($("#d").html() + "<option value='" + obj[i].fieldname + "' >" + obj[i].fieldlabel + "</option>");
							}
						}
					}
				},
				fail : function(res) {
					Dialog.alert("系统错误?!");
				}
			});
		}

		$(document).ready(function() {
			$("#sel").change(function(){
				$("#show_div").attr("style","");
			});
		});
	</script>
</head>
<body leftmargin="0" topmargin="0" class="easyui-layout">
<form name='form1' id="form1" method='post'>
	<input type="hidden" id="rule" name="rule" />
	<input type="hidden" id="sxxw_id" name="sxxw_id" />
	<input type="hidden" id="sxqx_id" name="sxqx_id" />
	<input type="hidden" id="tableid" name="tableid" />
	<div region="center" border="false" style="width: 100%; height: 100%; padding: 0px 10px 10px;">
		<table width="98%" border="0" align="center" cellpadding="0"
			   cellspacing="0" class="table_auto margin_top15 table_titlebk">
			<tr>
				<td class="table_title">
					规则描述
				</td>
			</tr>
		</table>
		<table width="98%" border="0" align="center" cellpadding="0"
			   cellspacing="0" class="table_auto table_nrbk">
			<tr>
				<td valign="top" class="padding10">
					<table width="100%" border="0" cellpadding="0" cellspacing="3">
						<tr>
							<td width="80" align="right" nowrap>
								规则名称：
							</td>
							<td width="140">
								<input type="text" name="rule_name" id="rule_name" verify="规则名称|NotNull" />
							</td>
							<td width="80" align="right">
								所属类别：
							</td>
							<td>
								<select name="xy_type" id="xy_type" onchange="changeSelect('xy_type','sxxw','');">
									<option value="0">全部</option>
									#if($csValues)
									#foreach($obj1 in $csValues)
									<option value="$!obj1.code">
										<script type="text/javascript">
											typesvalues[index]=new Array('$!obj1.code','$!obj1.value');
											index++;
											document.write(gettreecode('$!obj1.code'));
										</script>$!obj1.name
									</option>
									#end
									#end
								</select>
							</td>
						</tr>
						<tr bgcolor="#ffffff">
							<td width="80" align="right" nowrap>
								规则描述：
							</td>
							<td colspan="3">
								<textarea rows="4" cols="90%" name="note" id="note" verify="规则描述|NotNull"></textarea>
							</td>
						</tr>
						<tr bgcolor="#ffffff">
							<td width="80" align="right" nowrap>
								短信模版：
							</td>
							<td colspan="3">
								<textarea rows="2" cols="90%" name="sms_model" id="sms_model"></textarea>
							</td>
						</tr>
						<tr bgcolor="#ffffff">
							<td width="80" align="right" nowrap>
								惩戒期限：
							</td>
							<td colspan="3" >
								<input type="text" name="cjqx" verify="惩戒期限|Number3" style="width: 40px;" /><span style="color:firebrick">  （单位：月）</span>
							</td>
						</tr>
						<tr bgcolor="#ffffff">
							<td width="80" align="right" nowrap>
								立即生效：
							</td>
							<td colspan="3" >
								<label>&nbsp;是<input type="radio" name="is_work" value="1" checked style="vertical-align:-3px;"></label>
								<label>&nbsp;否<input type="radio" name="is_work" value="0" style="vertical-align:-3px;"></label>
							</td>
						</tr>
					</table>
				</td>
			</tr>
		</table>
		<table width="98%" border="0" align="center" cellpadding="0"
			   cellspacing="0" class="table_auto margin_top15 table_titlebk">
			<tr>
				<td class="table_title">
					失信行为
				</td>
			</tr>
		</table>
		<table width="98%" border="0" align="center" cellpadding="0"
			   cellspacing="0" class="table_auto table_nrbk">
			<tr>
				<td valign="top" class="padding10">
					<table width="100%" border="0" cellpadding="0" cellspacing="3">
						<tr>
							<td width="80" align="right" nowrap>
								失信行为：
							</td>
							<td width="*" align="left" colspan="3">
								<select id="sxxw" name="sxxw" onchange="changeSelect('xy_type','sxqx','sxxw');">
									<option value="0">请选择</option>
								</select>
							</td>
						</tr>
						<div>
							<tr>
								<td width="80" align="right" nowrap>
									失信情形：
								</td>
								<td width="*" align="left" colspan="3">
									<select id="sxqx" name="sxqx" onchange="changeSelect('xy_type','cjcs','sxqx');">
										<option value="0">请选择</option>
									</select>
								</td>
							</tr>
						</div>
						<div>
							<tr>
								<td width="80" align="right" nowrap>
									惩戒措施：
								</td>
								<td width="*" align="left" colspan="3">
									<select id="cjcs" name="cjcs" >
										<option value="0">请选择</option>
									</select>
								</td>
							</tr>
						</div>
					</table>
				</td>
			</tr>
		</table>
		<table width="98%" border="0" align="center" cellpadding="0"
			   cellspacing="0" class="table_auto margin_top15 table_titlebk">
			<tr>
				<td class="table_title">
					预警规则
					<!--<select>-->
						<!--<option>数字类型</option>-->
						<!--<option>时间类型</option>-->
						<!--<option>组合类型</option>-->
					<!--</select>-->
				</td>
			</tr>
		</table>
		<table width="98%" border="0" align="center" cellpadding="0"  cellspacing="0" class="table_auto table_nrbk">
			<tr>
				<td valign="top" class="padding10">
					<table width="100%" border="0" cellpadding="0" cellspacing="3">
						<tr>
							<td width="60" align="right" nowrap>
								指定表：
							</td>
							<td width="*" colspan="3">
								<select name="table_name" id="table_name" onchange="setTbaleOption();">
									<option value="0">请选择</option>
								</select>
							</td>
						</tr>
						<tr bgcolor="#ffffff">
							<td width="120" align="left" nowrap colspan="4">
								<div id="gz_val">
									绑定表单项(<span style="color:firebrick;">应履行</span>)
									<select id="b">
										<option value="0">请选择</option>
									</select>
									匹配规则
									<select id="c">
										<option>请选择</option>
										<option>大于</option>
										<option>大于等于</option>
										<option>等于</option>
										<option>小于</option>
										<option>小于等于</option>
									</select>
									匹配表单项(<span style="color:firebrick;">实际履行</span>)
									<select id="d">
										<option value="0">请选择</option>
									</select>
									<input class="button" type="button" name="btnOk" value="添加"
										   onclick="gz_add();" />
								</div>
							</td>
						</tr>
						<tr>
							<td width="40" align="left" nowrap>
								规则：
							</td>
							<td width="*" colspan="3">
								<span id="gz"></span>
								<span style='color:red;display: none;' id="yj_span" >
									当满足上述条件时，视为需要预警！
								</span>
							</td>
						</tr>
					</table>
				</td>
			</tr>
		</table>
	</div>
	<div region="south" border="false"
		 style="overflow: hidden; padding: 10px 10px 0px 10px">
		<div align="center" style="padding-bottom: 10px;">
			<input class="button" type="button" name="btnOk" value="确认"
				   onclick="doSave()" />
			<input class="button" type="button" name="btnOk" value="关闭"
				   onclick="window.close();" />
		</div>
	</div>
</form>
</body>
</html>