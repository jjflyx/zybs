(function(){function d(p,g){var h=domUtils.getNodeIndex;p=p.duplicate();p.collapse(g);var t=p.parentElement();if(!t.hasChildNodes()){return{container:t,offset:0};}var s=t.children,j,l=p.duplicate(),u=0,o=s.length-1,q=-1,f;while(u<=o){q=Math.floor((u+o)/2);j=s[q];l.moveToElementText(j);var n=l.compareEndPoints("StartToStart",p);if(n>0){o=q-1;}else{if(n<0){u=q+1;}else{return{container:t,offset:h(j)};}}}if(q==-1){l.moveToElementText(t);l.setEndPoint("StartToStart",p);f=l.text.replace(/(\r\n|\r)/g,"\n").length;s=t.childNodes;if(!f){j=s[s.length-1];return{container:j,offset:j.nodeValue.length};}var m=s.length;while(f>0){f-=s[--m].nodeValue.length;}return{container:s[m],offset:-f};}l.collapse(n>0);l.setEndPoint(n>0?"StartToStart":"EndToStart",p);f=l.text.replace(/(\r\n|\r)/g,"\n").length;if(!f){return dtd.$empty[j.tagName]||dtd.$nonChild[j.tagName]?{container:t,offset:h(j)+(n>0?0:1)}:{container:j,offset:n>0?0:j.childNodes.length};}while(f>0){try{var k=j;j=j[n>0?"previousSibling":"nextSibling"];f-=j.nodeValue.length;}catch(r){return{container:t,offset:h(k)};}}return{container:j,offset:n>0?-f:j.nodeValue.length+f};}function c(g,f){if(g.item){f.selectNode(g.item(0));}else{var e=d(g,true);f.setStart(e.container,e.offset);if(g.compareEndPoints("StartToEnd",g)!=0){e=d(g,false);f.setEnd(e.container,e.offset);}}return f;}function b(h){var g;try{g=h.getNative().createRange();}catch(i){return null;}var f=g.item?g.item(0):g.parentElement();if((f.ownerDocument||f)===h.document){return g;}return null;}var a=dom.Selection=function(g){var f=this,e;f.document=g;if(ie){e=domUtils.getWindow(g).frameElement;domUtils.on(e,"beforedeactivate",function(){f._bakIERange=f.getIERange();});domUtils.on(e,"activate",function(){try{if(!b(f)&&f._bakIERange){f._bakIERange.select();}}catch(h){}f._bakIERange=null;});}e=g=null;};a.prototype={getNative:function(){var g=this.document;try{return !g?null:ie?g.selection:domUtils.getWindow(g).getSelection();}catch(f){return null;}},getIERange:function(){var e=b(this);if(!e){if(this._bakIERange){return this._bakIERange;}}return e;},cache:function(){this.clear();this._cachedRange=this.getRange();this._cachedStartElement=this.getStart();this._cachedStartElementPath=this.getStartElementPath();},getStartElementPath:function(){if(this._cachedStartElementPath){return this._cachedStartElementPath;}var e=this.getStart();if(e){return domUtils.findParents(e,true,null,true);}return[];},clear:function(){this._cachedStartElementPath=this._cachedRange=this._cachedStartElement=null;},isFocus:function(){try{return browser.ie&&b(this)||!browser.ie&&this.getNative().rangeCount?true:false;}catch(f){return false;}},getRange:function(){var h=this;function g(l){var n=h.document.body.firstChild,m=l.collapsed;while(n&&n.firstChild){l.setStart(n,0);n=n.firstChild;}if(!l.startContainer){l.setStart(h.document.body,0);}if(m){l.collapse(true);}}if(h._cachedRange!=null){return this._cachedRange;}var f=new baidu.editor.dom.Range(h.document);if(ie){var j=h.getIERange();if(j){c(j,f);}else{g(f);}}else{var i=h.getNative();if(i&&i.rangeCount){var e=i.getRangeAt(0);var k=i.getRangeAt(i.rangeCount-1);f.setStart(e.startContainer,e.startOffset).setEnd(k.endContainer,k.endOffset);if(f.collapsed&&domUtils.isBody(f.startContainer)&&!f.startOffset){g(f);}}else{if(this._bakRange&&domUtils.inDoc(this._bakRange.startContainer,this.document)){return this._bakRange;}g(f);}}return this._bakRange=f;},getStart:function(){if(this._cachedStartElement){return this._cachedStartElement;}var e=ie?this.getIERange():this.getRange(),h,i,f,g;if(ie){if(!e){return this.document.body.firstChild;}if(e.item){return e.item(0);}h=e.duplicate();h.text.length>0&&h.moveStart("character",1);h.collapse(1);i=h.parentElement();g=f=e.parentElement();while(f=f.parentNode){if(f==i){i=g;break;}}}else{e.shrinkBoundary();i=e.startContainer;if(i.nodeType==1&&i.hasChildNodes()){i=i.childNodes[Math.min(i.childNodes.length-1,e.startOffset)];}if(i.nodeType==3){return i.parentNode;}}return i;},getText:function(){var e,f;if(this.isFocus()&&(e=this.getNative())){f=browser.ie?e.createRange():e.getRangeAt(0);return browser.ie?f.text:f.toString();}return"";}};})();