UE.plugins["undo"]=function(){var j=this,n=j.options.maxUndoCount||20,i=j.options.maxInputCount||20,e=new RegExp(domUtils.fillChar+"|</hr>","gi"),a=/\b(?:href|src|name)="[^"]*?"/gi;function l(o){var p=this;p.collapsed=o.collapsed;p.startAddr=k(o.startContainer,o.startOffset);p.endAddr=o.collapsed?p.startAddr:k(o.endContainer,o.endOffset);}l.prototype={compare:function(o){if(j.collapsed!==o.collapsed){return 0;}if(!g(j.startAddr,o.startAddr)||!g(j.endAddr,o.endAddr)){return 0;}return 1;},transformRange:function(o){var p=this;o.collapsed=p.collapsed;d(o,"start",p.startAddr);o.collapsed?o.collapse(true):d(o,"end",p.endAddr);}};function k(u,q){for(var s=0,o=[q],r,p=domUtils.findParents(u,true,function(v){return !domUtils.isBody(v);},true);r=p[s++];){if(s==1&&r.nodeType==3){var t=r;while(t=t.previousSibling){if(t.nodeType==3){q+=t.nodeValue.replace(fillCharReg,"").length;}else{break;}}o[0]=q;}o.push(domUtils.getNodeIndex(r,true));}return o.reverse();}function g(r,q){if(r.length!=q.length){return 0;}for(var p=0,o=r.length;p<o;p++){if(r[p]!=q[p]){return 0;}}return 1;}function d(p,t,s){r=p.document.body;for(var q=0,r,o=s.length-1;q<o;q++){r=r.childNodes[s[q]];}p[t+"Container"]=r;p[t+"Offset"]=s[s.length-1];}function c(){this.list=[];this.index=0;this.hasUndo=false;this.hasRedo=false;this.undo=function(){if(this.hasUndo){var p=this.getScene(),o=this.list[this.index];if(o.content.replace(a,"")!=p.content.replace(a,"")){this.save();}if(!this.list[this.index-1]&&this.list.length==1){this.reset();return;}while(this.list[this.index].content==this.list[this.index-1].content){this.index--;if(this.index==0){return this.restore(0);}}this.restore(--this.index);}};this.redo=function(){if(this.hasRedo){while(this.list[this.index].content==this.list[this.index+1].content){this.index++;if(this.index==this.list.length-1){return this.restore(this.index);}}this.restore(++this.index);}};this.restore=function(){var t=this.list[this.index];j.document.body.innerHTML=t.bookcontent.replace(e,"");if(browser.ie){for(var p=0,s,u=j.document.getElementsByTagName("p");s=u[p++];){if(s.innerHTML==""){domUtils.fillNode(j.document,s);}}}var o=new dom.Range(j.document);try{if(browser.opera||browser.safari){t.senceRange.transformRange(o);}else{o.moveToBookmark({start:"_baidu_bookmark_start_",end:"_baidu_bookmark_end_",id:true});}if(browser.ie&&browser.version==9&&o.collapsed&&domUtils.isBlockElm(o.startContainer)&&domUtils.isEmptyNode(o.startContainer)){domUtils.fillNode(o.document,o.startContainer);}o.select(!browser.gecko);if(!(browser.opera||browser.safari)){setTimeout(function(){o.scrollToView(j.autoHeightEnabled,j.autoHeightEnabled?domUtils.getXY(j.iframe).y:0);},200);}}catch(r){}this.update();if(j.currentSelectedArr){j.currentSelectedArr=[];var q=j.document.getElementsByTagName("td");for(var p=0,v;v=q[p++];){if(v.className==j.options.selectedTdClass){j.currentSelectedArr.push(v);}}}this.clearKey();j.fireEvent("reset",true);};this.getScene=function(){var p=j.selection.getRange(),o=j.body.innerHTML.replace(e,"");p.shrinkBoundary();browser.ie&&(o=o.replace(/>&nbsp;</g,"><").replace(/\s*</g,"").replace(/>\s*/g,">"));if(browser.opera||browser.safari){return{senceRange:new l(p),content:o,bookcontent:o};}else{var r=p.createBookmark(true,true),q=j.body.innerHTML.replace(e,"");r&&p.moveToBookmark(r).select(true);return{bookcontent:q,content:o};}};this.save=function(){var p=this.getScene(),o=this.list[this.index];if(o&&o.content==p.content&&((browser.opera||browser.safari)?o.senceRange.compare(p.senceRange):o.bookcontent==p.bookcontent)){return;}this.list=this.list.slice(0,this.index+1);this.list.push(p);if(this.list.length>n){this.list.shift();}this.index=this.list.length-1;this.clearKey();this.update();};this.update=function(){this.hasRedo=this.list[this.index+1]?true:false;this.hasUndo=this.list[this.index-1]||this.list.length==1?true:false;};this.reset=function(){this.list=[];this.index=0;this.hasUndo=false;this.hasRedo=false;this.clearKey();};this.clearKey=function(){f=0;b=null;j.fireEvent("contentchange");};}j.undoManger=new c();function h(){this.undoManger.save();}j.addListener("beforeexeccommand",h);j.addListener("afterexeccommand",h);j.addListener("reset",function(p,o){if(!o){j.undoManger.reset();}});j.commands["redo"]=j.commands["undo"]={execCommand:function(o){j.undoManger[o]();},queryCommandState:function(o){return j.undoManger["has"+(o.toLowerCase()=="undo"?"Undo":"Redo")]?0:-1;},notNeedUndo:1};var m={16:1,17:1,18:1,37:1,38:1,39:1,40:1,13:1},f=0,b;j.addListener("keydown",function(p,o){var q=o.keyCode||o.which;if(!m[q]&&!o.ctrlKey&&!o.metaKey&&!o.shiftKey&&!o.altKey){if(j.undoManger.list.length==0||((q==8||q==46)&&b!=q)){j.undoManger.save(true);b=q;return;}if(j.undoManger.list.length==2&&j.undoManger.index==0&&f==0){j.undoManger.list.splice(1,1);j.undoManger.update();}b=q;f++;if(f>=i){if(j.selection.getRange().collapsed){j.undoManger.save();}}}});};