(function(){function c(f){f=f||{};this.indentChar=f.indentChar||"    ";this.breakChar=f.breakChar||"\n";this.selfClosingEnd=f.selfClosingEnd||" />";}var e=function(){var g={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};function f(h){return g[h];}return function(h){h=h+"";return h?h.replace(/[<>"']/g,f):"";};}();var d=utils.extend({a:1,A:1},dtd.$inline,true);function b(g){var h=[];for(var f in g){h.push(f+'="'+e(g[f])+'"');}return h.join(" ");}c.prototype={format:function(f){var g=UE.serialize.parseHTML(f);this.buff=[];this.indents="";this.indenting=1;this.visitNode(g);return this.buff.join("");},visitNode:function(g){if(g.type=="fragment"){this.visitChildren(g.children);}else{if(g.type=="element"){var f=dtd.$empty[g.tag];this.visitTag(g.tag,g.attributes,f);this.visitChildren(g.children);if(!f){this.visitEndTag(g.tag);}}else{if(g.type=="comment"){this.visitComment(g.data);}else{this.visitText(g.data,dtd.$notTransContent[g.parent.tag]);}}}},visitChildren:function(g){for(var f=0;f<g.length;f++){this.visitNode(g[f]);}},visitTag:function(f,h,g){if(this.indenting){this.indent();}else{if(!d[f]){this.newline();this.indent();}}this.buff.push("<",f);var i=b(h);if(i){this.buff.push(" ",i);}if(g){this.buff.push(this.selfClosingEnd);if(f=="br"){this.newline();}}else{this.buff.push(">");this.indents+=this.indentChar;}if(!d[f]){this.newline();}},indent:function(){this.buff.push(this.indents);this.indenting=0;},newline:function(){this.buff.push(this.breakChar);this.indenting=1;},visitEndTag:function(f){this.indents=this.indents.slice(0,-this.indentChar.length);if(this.indenting){this.indent();}else{if(!d[f]){this.newline();this.indent();}}this.buff.push("</",f,">");},visitText:function(g,f){if(this.indenting){this.indent();}g=g.replace(/&nbsp;/g," ");this.buff.push(g);},visitComment:function(f){if(this.indenting){this.indent();}this.buff.push("<!--",f,"-->");}};var a={textarea:function(h,g){var f=g.ownerDocument.createElement("textarea");f.style.cssText="position:absolute;resize:none;width:100%;height:100%;border:0;padding:0;margin:0;overflow-y:auto;";if(browser.ie&&browser.version<8){f.style.width=g.offsetWidth+"px";f.style.height=g.offsetHeight+"px";g.onresize=function(){f.style.width=g.offsetWidth+"px";f.style.height=g.offsetHeight+"px";};}g.appendChild(f);return{setContent:function(i){f.value=i;},getContent:function(){return f.value;},select:function(){var i;if(browser.ie){i=f.createTextRange();i.collapse(true);i.select();}else{f.setSelectionRange(0,0);f.focus();}},dispose:function(){g.removeChild(f);g.onresize=null;f=null;g=null;}};},codemirror:function(i,h){var g={mode:"text/html",tabMode:"indent",lineNumbers:true,lineWrapping:true};var f=window.CodeMirror(h,g);var j=f.getWrapperElement();j.style.cssText='position:absolute;left:0;top:0;width:100%;height:100%;font-family:consolas,"Courier new",monospace;font-size:13px;';f.getScrollerElement().style.cssText="position:absolute;left:0;top:0;width:100%;height:100%;";f.refresh();return{setContent:function(k){f.setValue(k);},getContent:function(){return f.getValue();},select:function(){f.focus();},dispose:function(){h.removeChild(j);j=null;f=null;}};}};UE.plugins["source"]=function(){var j=this;var f=this.options;var l=new c(f.source);var i=false;var m;f.sourceEditor=f.sourceEditor||"codemirror";j.setOpt({sourceEditorFirst:false});function g(o){return a[f.sourceEditor=="codemirror"&&window.CodeMirror?"codemirror":"textarea"](j,o);}var n;j.commands["source"]={execCommand:function(){i=!i;if(i){j.undoManger&&j.undoManger.save();this.currentSelectedArr&&domUtils.clearSelectedArr(this.currentSelectedArr);if(browser.gecko){j.body.contentEditable=false;}n=j.iframe.style.cssText;j.iframe.style.cssText+="position:absolute;left:-32768px;top:-32768px;";var p=l.format(j.hasContents()?j.getContent():"");m=g(j.iframe.parentNode);m.setContent(p);setTimeout(function(){m.select();});}else{j.iframe.style.cssText=n;var o=m.getContent()||"<p>"+(browser.ie?"":"<br/>")+"</p>";o=o.replace(/>[\n\r\t]+([ ]{4})+/g,">").replace(/[\n\r\t]+([ ]{4})+</g,"<").replace(/>[\n\r\t]+</g,"><");j.setContent(o);m.dispose();m=null;setTimeout(function(){var s=j.body.firstChild;if(!s){j.body.innerHTML="<p>"+(browser.ie?"":"<br/>")+"</p>";s=j.body.firstChild;}j.undoManger&&j.undoManger.save();while(s&&s.firstChild){s=s.firstChild;}var r=j.selection.getRange();if(s.nodeType==3||dtd.$empty[s.tagName]){r.setStartBefore(s);}else{r.setStart(s,0);}if(browser.gecko){var q=document.createElement("input");q.style.cssText="position:absolute;left:0;top:-32768px";document.body.appendChild(q);j.body.contentEditable=false;setTimeout(function(){domUtils.setViewportOffset(q,{left:-32768,top:0});q.focus();setTimeout(function(){j.body.contentEditable=true;r.setCursor(false,true);domUtils.remove(q);});});}else{r.setCursor(false,true);}});}this.fireEvent("sourcemodechanged",i);},queryCommandState:function(){return i|0;},notNeedUndo:1};var h=j.queryCommandState;j.queryCommandState=function(o){o=o.toLowerCase();if(i){return o=="source"?1:-1;}return h.apply(this,arguments);};var k=j.getContent;j.getContent=function(){if(i&&m){var o=m.getContent();if(this.serialize){var p=this.serialize.parseHTML(o);p=this.serialize.filter(p);o=this.serialize.toHTML(p);}return o;}else{return k.apply(this,arguments);}};if(f.sourceEditor=="codemirror"){j.addListener("ready",function(){utils.loadFile(document,{src:f.codeMirrorJsUrl||f.UEDITOR_HOME_URL+"third-party/codemirror2.15/codemirror.js",tag:"script",type:"text/javascript",defer:"defer"},function(){if(f.sourceEditorFirst){setTimeout(function(){j.execCommand("source");},0);}});utils.loadFile(document,{tag:"link",rel:"stylesheet",type:"text/css",href:f.codeMirrorCssUrl||f.UEDITOR_HOME_URL+"third-party/codemirror2.15/codemirror.css"});});}};})();