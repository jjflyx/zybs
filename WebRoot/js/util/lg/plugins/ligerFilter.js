(function(a){a.fn.ligerFilter=function(){return a.ligerui.run.call(this,"ligerFilter",arguments);};a.fn.ligerGetFilterManager=function(){return a.ligerui.run.call(this,"ligerGetFilterManager",arguments);};a.ligerDefaults.Filter={fields:[],operators:{},editors:{}};a.ligerDefaults.FilterString={strings:{"and":"并且","or":"或者","equal":"相等","notequal":"不相等","startwith":"以..开始","endwith":"以..结束","like":"相似","greater":"大于","greaterorequal":"大于或等于","less":"小于","lessorequal":"小于或等于","in":"包括在...","notin":"不包括...","addgroup":"增加分组","addrule":"增加条件","deletegroup":"删除分组"}};a.ligerDefaults.Filter.operators["string"]=a.ligerDefaults.Filter.operators["text"]=["equal","notequal","startwith","endwith","like","greater","greaterorequal","less","lessorequal","in","notin"];a.ligerDefaults.Filter.operators["number"]=a.ligerDefaults.Filter.operators["int"]=a.ligerDefaults.Filter.operators["float"]=a.ligerDefaults.Filter.operators["date"]=["equal","notequal","greater","greaterorequal","less","lessorequal","in","notin"];a.ligerDefaults.Filter.editors["string"]={create:function(b,d){var c=a("<input type='text'/>");b.append(c);c.ligerTextBox(d.editor.options||{});return c;},setValue:function(b,c){b.val(c);},getValue:function(b){return b.liger("option","value");},destroy:function(b){b.liger("destroy");}};a.ligerDefaults.Filter.editors["date"]={create:function(b,d){var c=a("<input type='text'/>");b.append(c);c.ligerDateEditor(d.editor.options||{});return c;},setValue:function(b,c){b.liger("option","value",c);},getValue:function(b,c){return b.liger("option","value");},destroy:function(b){b.liger("destroy");}};a.ligerDefaults.Filter.editors["number"]={create:function(b,e){var c=a("<input type='text'/>");b.append(c);var d={minValue:e.editor.minValue,maxValue:e.editor.maxValue};c.ligerSpinner(a.extend(d,e.editor.options||{}));return c;},setValue:function(b,c){b.val(c);},getValue:function(b,d){var c=d.editor.type=="int";if(c){return parseInt(b.val(),10);}else{return parseFloat(b.val());}},destroy:function(b){b.liger("destroy");}};a.ligerDefaults.Filter.editors["combobox"]={create:function(b,e){var c=a("<input type='text'/>");b.append(c);var d={data:e.data,slide:false,valueField:e.editor.valueField||e.editor.valueColumnName,textField:e.editor.textField||e.editor.displayColumnName};a.extend(d,e.editor.options||{});c.ligerComboBox(d);return c;},setValue:function(b,c){b.liger("option","value",c);},getValue:function(b){return b.liger("option","value");},destroy:function(b){b.liger("destroy");}};a.ligerui.controls.Filter=function(c,b){a.ligerui.controls.Filter.base.constructor.call(this,c,b);};a.ligerui.controls.Filter.ligerExtend(a.ligerui.core.UIComponent,{__getType:function(){return"Filter";},__idPrev:function(){return"Filter";},_init:function(){a.ligerui.controls.Filter.base._init.call(this);},_render:function(){var b=this,c=this.options;b.set(c);a("#"+b.id+" .addgroup").live("click",function(){var d=a(this).parent().parent().parent().parent();b.addGroup(d);});a("#"+b.id+" .deletegroup").live("click",function(){var d=a(this).parent().parent().parent().parent();b.deleteGroup(d);});a("#"+b.id+" .addrule").live("click",function(){var d=a(this).parent().parent().parent().parent();b.addRule(d);});a("#"+b.id+" .deleterole").live("click",function(){var d=a(this).parent().parent();b.deleteRule(d);});},_setFields:function(b){var c=this,d=this.options;if(c.group){c.group.remove();}c.group=a(c._bulidGroupTableHtml()).appendTo(c.element);},editors:{},editorCounter:0,addGroup:function(c){var e=this,f=this.options;c=a(c||e.group);var i=a(">tbody:first > tr:last",c);var b=[];b.push('<tr class="l-filter-rowgroup"><td class="l-filter-cellgroup" colSpan="4">');var d=!c.hasClass("l-filter-group-alt");b.push(e._bulidGroupTableHtml(d,true));b.push("</td></tr>");var h=a(b.join(""));i.before(h);return h.find("table:first");},deleteGroup:function(d){var b=this,c=this.options;a("td.l-filter-value",d).each(function(){var e=a(this).parent();a("select.fieldsel",e).unbind();b.removeEditor(e);});a(d).parent().parent().remove();},removeEditor:function(b){var e=this,f=this.options;var d=a(b).attr("editortype");var h=a(b).attr("editorid");var c=e.editors[h];if(c){f.editors[d].destroy(c);}a("td.l-filter-value:first",b).html("");},setData:function(e,b){var c=this,d=this.options;b=b||c.group;var f=a(">tbody:first > tr:last",b);b.find(">tbody:first > tr").not(f).remove();a("select:first",f).val(e.op);if(e.rules){a(e.rules).each(function(){var g=c.addRule(b);g.attr("fieldtype",this.type||"string");a("select.opsel",g).val(this.op);a("select.fieldsel",g).val(this.field).trigger("change");var h=g.attr("editorid");if(h&&c.editors[h]){var i=c.getField(this.field);d.editors[i.editor.type].setValue(c.editors[h],this.value,i);}else{a(":text",g).val(this.value);}});}if(e.groups){a(e.groups).each(function(){var g=c.addGroup(b);c.setData(this,g);});}},addRule:function(c){var d=this,e=this.options;c=c||d.group;var f=a(">tbody:first > tr:last",c);var b=a(d._bulidRuleRowHtml());f.before(b);if(e.fields.length){d.appendEditor(b,e.fields[0]);}a("select.fieldsel",b).bind("change",function(){var k=a(this).parent().next().find("select:first");var m=a(this).val();var l=d.getField(m);var j=l.type||"string";var h=b.attr("fieldtype");if(j!=h){k.html(d._bulidOpSelectOptionsHtml(j));b.attr("fieldtype",j);}var g=null;var i=b.attr("editortype");if(d.enabledEditor(l)){g=l.editor.type;}if(i){d.removeEditor(b);}if(g){d.appendEditor(b,l);}else{b.removeAttr("editortype").removeAttr("editorid");a("td.l-filter-value:first",b).html('<input type="text" class="valtxt" />');}});return b;},deleteRule:function(b){a("select.fieldsel",b).unbind();this.removeEditor(b);a(b).remove();},appendEditor:function(c,h){var e=this,f=this.options;if(e.enabledEditor(h)){var b=a("td.l-filter-value:first",c).html("");var d=f.editors[h.editor.type];e.editors[++e.editorCounter]=d.create(b,h);c.attr("editortype",h.editor.type).attr("editorid",e.editorCounter);}},getData:function(e){var c=this,d=this.options;e=e||c.group;var b={};a("> tbody > tr",e).each(function(j,p){var h=a(p).hasClass("l-filter-rowlast");var g=a(p).hasClass("l-filter-rowgroup");if(g){var f=a("> td:first > table:first",p);if(f.length){if(!b.groups){b.groups=[];}b.groups.push(c.getData(f));}}else{if(h){b.op=a(".groupopsel:first",p).val();}else{var o=a("select.fieldsel:first",p).val();var m=c.getField(o);var k=a(".opsel:first",p).val();var n=c._getRuleValue(p,m);var l=a(p).attr("fieldtype")||"string";if(!b.rules){b.rules=[];}b.rules.push({field:o,op:k,value:n,type:l});}}});return b;},_getRuleValue:function(b,i){var f=this,h=this.options;var d=a(b).attr("editorid");var c=a(b).attr("editortype");var e=f.editors[d];if(e){return h.editors[c].getValue(e,i);}return a(".valtxt:first",b).val();},enabledEditor:function(d){var b=this,c=this.options;if(!d.editor||!d.editor.type){return false;}return(d.editor.type in c.editors);},getField:function(c){var e=this,h=this.options;for(var d=0,b=h.fields.length;d<b;d++){var f=h.fields[d];if(f.name==c){return f;}}return null;},_bulidGroupTableHtml:function(c,b){var d=this,f=this.options;var e=[];e.push('<table cellpadding="0" cellspacing="0" border="0" class="l-filter-group');if(c){e.push(" l-filter-group-alt");}e.push('"><tbody>');e.push('<tr class="l-filter-rowlast"><td class="l-filter-rowlastcell" align="right" colSpan="4">');e.push('<select class="groupopsel">');e.push('<option value="and">'+f.strings["and"]+"</option>");e.push('<option value="or">'+f.strings["or"]+"</option>");e.push("</select>");e.push('<input type="button" value="'+f.strings["addgroup"]+'" class="addgroup">');e.push('<input type="button" value="'+f.strings["addrule"]+'" class="addrule">');if(b){e.push('<input type="button" value="'+f.strings["deletegroup"]+'" class="deletegroup">');}e.push("</td></tr>");e.push("</tbody></table>");return e.join("");},_bulidRuleRowHtml:function(b){var h=this,k=this.options;b=b||k.fields;var f=[];var d=b[0].type||"string";f.push('<tr fieldtype="'+d+'"><td class="l-filter-column">');f.push('<select class="fieldsel">');for(var e=0,c=b.length;e<c;e++){var j=b[e];f.push('<option value="'+j.name+'"');if(e==0){f.push(" selected ");}f.push(">");f.push(j.display);f.push("</option>");}f.push("</select>");f.push("</td>");f.push('<td class="l-filter-op">');f.push('<select class="opsel">');f.push(h._bulidOpSelectOptionsHtml(d));f.push("</select>");f.push("</td>");f.push('<td class="l-filter-value">');f.push('<input type="text" class="valtxt" />');f.push("</td>");f.push("<td>");f.push('<div class="l-icon-cross deleterole"></div>');f.push("</td>");f.push("</tr>");return f.join("");},_bulidOpSelectOptionsHtml:function(d){var h=this,j=this.options;var f=j.operators[d];var b=[];for(var e=0,c=f.length;e<c;e++){var k=f[e];b[b.length]='<option value="'+k+'">';b[b.length]=j.strings[k];b[b.length]="</option>";}return b.join("");}});})(jQuery);